#!/bin/bash -eu
# Copyright (c) 2015, Heye Voecking <heye.voecking+exploit-exercises.com@gmail.com>

set -E
trap 'echo Failed on line: $BASH_SOURCE:$LINENO at command: $BASH_COMMAND && exit $?' ERR

SSH_OPTIONS="-o StrictHostKeyChecking=no -o LogLevel=Error -o BatchMode=yes"
SOCAT_SSH_OPTIONS="-o StrictHostKeyChecking=no -o LogLevel=Error"

# Execute command with delayed input
socat_exec() {
  (sleep 1; echo $1; sleep 0.1) |
    socat - EXEC:"$2",pty,setsid,ctty
}

# Register all traps to be excuted
# http://stackoverflow.com/questions/3338030/multiple-bash-traps-for-the-same-signal
registerTrap() {
    local trap_add_cmd=$1; shift || fatal "${FUNCNAME} usage error"
    local new_cmd=
    for trap_add_name in "$@"; do
        # Grab the currently defined trap commands for this trap
        local existing_cmd=`trap -p "${trap_add_name}" |  awk -F"'" '{print $2}'`

        # Define default command
        [ -z "${existing_cmd}" ] && local existing_cmd="true"

        # Generate the new command
        local new_cmd="${existing_cmd};${trap_add_cmd}"

        # Assign the test
         trap   "${new_cmd}" "${trap_add_name}" || \
                fatal "unable to add to trap ${trap_add_name}"
    done
}
